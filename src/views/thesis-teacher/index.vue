<!-- eslint-disable no-undef -->
<template>
  <el-container>
    <el-main>
      <el-row>
        <el-col :span="24">
          <h2>ğŸ“– è®ºæ–‡å®¡æ ¸</h2>
        </el-col>
      </el-row>

      <el-row>
        <el-col :span="24">
          <br />
          <h3>1. æŸ¥çœ‹å­¦ç”Ÿè®ºæ–‡</h3>
          <div v-for="(papers, name) in thesisAll" :key="name">
            <h4>{{ name }}</h4>
            <div class="table-wrapper">
              <el-table :data="papers.data" stripe style="width: 100%">

                <el-table-column fixed prop="tName" label="è®ºæ–‡é¢˜ç›®" width="150" align="center" />
                <el-table-column prop="tCategory" label="åˆ†ç±»" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.tCategory == 'æœŸåˆŠ'" type="info" effect="dark">æœŸåˆŠ</el-tag>
                    <el-tag v-else-if="scope.row.tCategory == 'ä¼šè®®'" effect="dark">ä¼šè®®</el-tag>
                    <el-tag v-else type="warning" effect="dark">å‡ºç‰ˆç‰©</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="tPublicationName" label="æœŸåˆŠå/ ä¼šè®®å/ å‡ºç‰ˆç¤¾å" align="center" />
                <el-table-column prop="tReviewResult" label="å®¡æ ¸ç»“æœ" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.tReviewResult == 'é€šè¿‡'" type="success">é€šè¿‡</el-tag>
                    <el-tag v-else-if="scope.row.tReviewResult == 'è¿›è¡Œä¸­'" type="warning">è¿›è¡Œä¸­</el-tag>
                    <el-tag v-else-if="scope.row.tReviewResult == 'ä¸é€šè¿‡'" type="danger">ä¸é€šè¿‡</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="tPublicationDate" label="å‡ºç‰ˆæ—¶é—´" align="center" />
                <el-table-column prop="authorIds" label="ä½œè€…ï¼ˆæŒ‰å‡ºç‰ˆé¡ºåºï¼‰" align="center">
                  <template #default="scope">
                    {{ papers.authorNameList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="correspondingAuthorId" label="é€šè®¯ä½œè€…" align="center">
                  <template #default="scope">
                    {{ papers.corrAuthorList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="tLink" label="é“¾æ¥" align="center" />
              </el-table>
            </div>
          </div>
        </el-col>
      </el-row>
      <el-row>
        <el-col :span="24">
          <br />
          <h3>2. å®¡æ ¸å­¦ç”Ÿè®ºæ–‡</h3>
          <div v-for="(papers, name) in thesisUnderReview" :key="name">
            <h4>{{ name }}</h4>
            <div class="table-wrapper">
              <el-table :data="papers.data" stripe style="width: 100%">
                <el-table-column fixed prop="tName" label="è®ºæ–‡é¢˜ç›®" width="150" align="center" />
                <el-table-column prop="tCategory" label="åˆ†ç±»" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.tCategory == 'æœŸåˆŠ'" type="info" effect="dark">æœŸåˆŠ</el-tag>
                    <el-tag v-else-if="scope.row.tCategory == 'ä¼šè®®'" effect="dark">ä¼šè®®</el-tag>
                    <el-tag v-else type="warning" effect="dark">å‡ºç‰ˆç‰©</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="tPublicationName" label="æœŸåˆŠå/ ä¼šè®®å/ å‡ºç‰ˆç¤¾å" align="center" />
                <el-table-column prop="tReviewResult" label="å®¡æ ¸ç»“æœ" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.tReviewResult == 'é€šè¿‡'" type="success">é€šè¿‡</el-tag>
                    <el-tag v-else-if="scope.row.tReviewResult == 'è¿›è¡Œä¸­'" type="warning">è¿›è¡Œä¸­</el-tag>
                    <el-tag v-else-if="scope.row.tReviewResult == 'ä¸é€šè¿‡'" type="danger">ä¸é€šè¿‡</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="tPublicationDate" label="å‡ºç‰ˆæ—¶é—´" align="center" />
                <el-table-column prop="authorIds" label="ä½œè€…ï¼ˆæŒ‰å‡ºç‰ˆé¡ºåºï¼‰" align="center">
                  <template #default="scope">
                    {{ papers.authorNameList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="correspondingAuthorId" label="é€šè®¯ä½œè€…" align="center">
                  <template #default="scope">
                    {{ papers.corrAuthorList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="tLink" label="é“¾æ¥" align="center" />
                <el-table-column label="æ“ä½œ" align="center">
                  <template #default="scope">
                    <el-button
                      v-if="scope.row.tReviewResult == 'è¿›è¡Œä¸­'"
                      round
                      size="small"
                      type="success"
                      @click="approve(scope.row)"
                      >é€šè¿‡</el-button
                    >
                    <el-button
                      v-if="scope.row.tReviewResult == 'è¿›è¡Œä¸­'"
                      round
                      size="small"
                      type="danger"
                      @click="reject(scope.row)"
                      >ä¸é€šè¿‡</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>
        </el-col>
      </el-row>
    </el-main></el-container
  >
</template>

<script lang="ts">
import { getStudentThesisByTeacherId, approveThesis, rejectThesis } from "@/api/thesis"
import { format, parseISO } from "date-fns"
import { ElMessage } from "element-plus"
export default {
  methods: {
    approve(paper) {
      // console.log(paper.tId)
      const thesisId = {
        thesisId: paper.tId
      }
      approveThesis(thesisId)
        .then((data) => {
          ElMessage.success("å®¡æ ¸é€šè¿‡")
          this.fetchThesis()
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ
          console.log(error)
        })
    },

    reject(paper) {
      const thesisId = {
        thesisId: paper.tId
      }
      rejectThesis(thesisId)
        .then((data) => {
          ElMessage.success("å®¡æ ¸ä¸é€šè¿‡")
          this.fetchThesis()
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ
          console.log(error)
        })
    },
    formatDate(date) {
      // ä½¿ç”¨ date-fns çš„ format å‡½æ•°è°ƒæ•´æ—¥æœŸæ ¼å¼
      return format(parseISO(date), "yyyy-MM-dd")
    },
    fetchThesis() {
      getStudentThesisByTeacherId()
        .then((data) => {
          this.thesisAll = data.data
          for (const papers of Object.values(this.thesisAll)) {
            for (const paper of papers.data) {
              paper.tPublicationDate = this.formatDate(paper.tPublicationDate)
            }
          }
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ
          console.log(error)
        })
    }
  },
  created() {
    this.fetchThesis()
  },
  computed: {
    thesisUnderReview() {
      const result = {}
      for (const [name, papers] of Object.entries(this.thesisAll)) {
        result[name] = {
          ...papers,
          data: papers.data.filter((paper) => paper.tReviewResult == "è¿›è¡Œä¸­")
        }
      }
      return result
    }
  },

  data() {
    return {
      thesisName: "",
      thesisCategory: "",
      thesisPublicationName: "",
      thesisPublicationDate: "",
      thesisCorrspongdingAuthor: "",
      thesisAuthors: "",
      thesisLink: "",
      thesisAll: []
    }
  }
}
</script>

<style lang="scss" scoped>
.search-wrapper {
  margin-bottom: 20px;
  :deep(.el-card__body) {
    padding-bottom: 2px;
  }
}

.toolbar-wrapper {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.table-wrapper {
  margin-bottom: 20px;
}

.pager-wrapper {
  display: flex;
  justify-content: flex-end;
}
</style>

.input-with-select .el-input-group__prepend { background-color: var(--el-fill-color-blank); }
