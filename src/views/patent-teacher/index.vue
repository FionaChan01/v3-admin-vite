<!-- eslint-disable no-undef -->
<template>
  <el-container>
    <el-main>
      <el-row>
        <el-col :span="24">
          <h2>ğŸ” ä¸“åˆ©å®¡æ ¸</h2>
        </el-col>
      </el-row>

      <el-row>
        <el-col :span="24">
          <br />
          <h3>1. æŸ¥çœ‹å­¦ç”Ÿä¸“åˆ©</h3>
          <div v-for="(patents, name) in patentAll" :key="name">
            <h4>{{ name }}</h4>
            <div class="table-wrapper">
              <el-table :data="patents.data" stripe style="width: 100%">
                <el-table-column fixed prop="patentName" label="ä¸“åˆ©åç§°" width="150" align="center" />
                <el-table-column prop="patentType" label="ä¸“åˆ©ç±»å‹" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentType == 'å‘æ˜ä¸“åˆ©'" type="info" effect="dark">å‘æ˜ä¸“åˆ©</el-tag>
                    <el-tag v-else-if="scope.row.patentType == 'å®ç”¨æ–°å‹ä¸“åˆ©'" effect="dark">å®ç”¨æ–°å‹ä¸“åˆ©</el-tag>
                    <el-tag v-else-if="scope.row.patentType == 'è½¯ä»¶ä¸“åˆ©'" type="success" effect="dark"
                      >è½¯ä»¶ä¸“åˆ©</el-tag
                    >
                    <el-tag v-else type="warning" effect="dark">å¤–è§‚è®¾è®¡ä¸“åˆ©</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="patentStatus" label="ä¸“åˆ©çŠ¶æ€" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentStatus == 'å·²æˆæƒ'" type="success" effect="plain">å·²æˆæƒ</el-tag>
                    <el-tag v-else-if="scope.row.patentStatus == 'ç”³è¯·ä¸­'" type="warning" effect="plain">ç”³è¯·ä¸­</el-tag>
                    <el-tag v-else-if="scope.row.patentStatus == 'å·²æ— æ•ˆ'" type="danger" effect="plain">å·²æ— æ•ˆ</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="patentApplyDate" label="ä¸“åˆ©ç”³è¯·æ—¥æœŸ" align="center" />
                <el-table-column prop="patentPubDate" label="ä¸“åˆ©å‘å¸ƒæ—¥æœŸ" align="center" />
                <el-table-column prop="patentInventors" label="å‘æ˜äººï¼ˆæŒ‰å‡ºç‰ˆé¡ºåºï¼‰" align="center">
                  <template #default="scope">
                    {{ patents.authorNameList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="patentNumber" label="ä¸“åˆ©å·" align="center" />
                <el-table-column prop="patentReviewResult" label="å®¡æ ¸ç»“æœ" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentReviewResult == 'é€šè¿‡'" type="success">é€šè¿‡</el-tag>
                    <el-tag v-else-if="scope.row.patentReviewResult == 'è¿›è¡Œä¸­'" type="warning">è¿›è¡Œä¸­</el-tag>
                    <el-tag v-else-if="scope.row.patentReviewResult == 'ä¸é€šè¿‡'" type="danger">ä¸é€šè¿‡</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>
        </el-col>
      </el-row>
      <el-row>
        <el-col :span="24">
          <br />
          <h3>2. å®¡æ ¸å­¦ç”Ÿè®ºæ–‡</h3>
          <div v-for="(patents, name) in patentUnderReview" :key="name">
            <h4>{{ name }}</h4>
            <div class="table-wrapper">
              <el-table :data="patents.data" stripe style="width: 100%">
                <el-table-column fixed prop="patentName" label="ä¸“åˆ©åç§°" width="150" align="center" />
                <el-table-column prop="patentType" label="ä¸“åˆ©ç±»å‹" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentType == 'å‘æ˜ä¸“åˆ©'" type="info" effect="dark">å‘æ˜ä¸“åˆ©</el-tag>
                    <el-tag v-else-if="scope.row.patentType == 'å®ç”¨æ–°å‹ä¸“åˆ©'" effect="dark">å®ç”¨æ–°å‹ä¸“åˆ©</el-tag>
                    <el-tag v-else-if="scope.row.patentType == 'è½¯ä»¶ä¸“åˆ©'" type="success" effect="dark"
                      >è½¯ä»¶ä¸“åˆ©</el-tag
                    >
                    <el-tag v-else type="warning" effect="dark">å¤–è§‚è®¾è®¡ä¸“åˆ©</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="patentStatus" label="ä¸“åˆ©çŠ¶æ€" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentStatus == 'å·²æˆæƒ'" type="success" effect="plain">å·²æˆæƒ</el-tag>
                    <el-tag v-else-if="scope.row.patentStatus == 'ç”³è¯·ä¸­'" type="warning" effect="plain">ç”³è¯·ä¸­</el-tag>
                    <el-tag v-else-if="scope.row.patentStatus == 'å·²æ— æ•ˆ'" type="danger" effect="plain">å·²æ— æ•ˆ</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="patentApplyDate" label="ä¸“åˆ©ç”³è¯·æ—¥æœŸ" align="center" />
                <el-table-column prop="patentPubDate" label="ä¸“åˆ©å‘å¸ƒæ—¥æœŸ" align="center" />
                <el-table-column prop="patentInventors" label="å‘æ˜äººï¼ˆæŒ‰å‡ºç‰ˆé¡ºåºï¼‰" align="center">
                  <template #default="scope">
                    {{ patents.authorNameList[scope.$index] }}
                  </template>
                </el-table-column>
                <el-table-column prop="patentNumber" label="ä¸“åˆ©å·" align="center" />
                <el-table-column prop="patentReviewResult" label="å®¡æ ¸ç»“æœ" align="center">
                  <template #default="scope">
                    <el-tag v-if="scope.row.patentReviewResult == 'é€šè¿‡'" type="success">é€šè¿‡</el-tag>
                    <el-tag v-else-if="scope.row.patentReviewResult == 'ä¸é€šè¿‡'" type="danger">ä¸é€šè¿‡</el-tag>
                    <el-tag v-else>è¿›è¡Œä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" align="center">
                  <template #default="scope">
                    <el-button
                      v-if="scope.row.patentReviewResult == 'è¿›è¡Œä¸­'"
                      round
                      size="small"
                      type="success"
                      @click="approve(scope.row)"
                      >é€šè¿‡</el-button
                    >
                    <el-button
                      v-if="scope.row.patentReviewResult == 'è¿›è¡Œä¸­'"
                      round
                      size="small"
                      type="danger"
                      @click="reject(scope.row)"
                      >ä¸é€šè¿‡</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>
        </el-col>
      </el-row>
    </el-main></el-container
  >
</template>

<script lang="ts">
import { getStudentPatentByTeacherId, approvePatent, rejectPatent } from "@/api/patent"
import { format, parseISO } from "date-fns"
import { ElMessage } from "element-plus"
export default {
  methods: {
    approve(patent) {
      const patentId = {
        patentId: patent.patentId
      }
      approvePatent(patentId)
        .then((data) => {
          ElMessage.success("å®¡æ ¸é€šè¿‡")
          this.fetchPatent()
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ
          console.log(error)
        })
    },

    reject(patent) {
      const patentId = {
        patentId: patent.patentId
      }
      rejectPatent(patentId)
        .then((data) => {
          ElMessage.success("å®¡æ ¸ä¸é€šè¿‡")
          this.fetchPatent()
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ2
          console.log(error)
        })
    },
    formatDate(date) {
      // æ£€æŸ¥æ—¥æœŸæ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆ
      if (!date) {
        // æ—¥æœŸä¸ºç©ºæˆ–æ— æ•ˆï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²æˆ–å…¶ä»–é”™è¯¯å¤„ç†é€»è¾‘
        return ""
      }
      // å°†æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸º Date å¯¹è±¡
      const parsedDate = new Date(date)
      // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
      if (isNaN(parsedDate)) {
        // æ—¥æœŸæ— æ•ˆï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²æˆ–å…¶ä»–é”™è¯¯å¤„ç†é€»è¾‘
        return ""
      }
      // ä½¿ç”¨ date-fns çš„ format å‡½æ•°è°ƒæ•´æ—¥æœŸæ ¼å¼
      return format(parseISO(date), "yyyy-MM-dd")
    },
    fetchPatent() {
      getStudentPatentByTeacherId()
        .then((data) => {
          this.patentAll = data.data
          for (const patents of Object.values(this.patentAll)) {
            for (const patent of patents.data) {
              // console.log("before")
              // console.log(patent.patentApplyDate)
              patent.patentApplyDate = this.formatDate(patent.patentApplyDate)
              // console.log("after")
              // console.log(patent.patentApplyDate)
              patent.patentPubDate = this.formatDate(patent.patentPubDate)
            }
          }
        })
        .catch((error: any) => {
          // å¤„ç†é”™è¯¯æƒ…å†µ
          console.log(error)
        })
    }
  },
  created() {
    this.fetchPatent()
  },
  computed: {
    patentUnderReview() {
      const result = {}
      for (const [name, patents] of Object.entries(this.patentAll)) {
        result[name] = {
          ...patents,
          data: patents.data.filter((patent) => patent.patentReviewResult == "è¿›è¡Œä¸­")
        }
      }
      return result
    }
  },

  data() {
    return {
      patentAll: []
    }
  }
}
</script>

<style lang="scss" scoped>
.search-wrapper {
  margin-bottom: 20px;
  :deep(.el-card__body) {
    padding-bottom: 2px;
  }
}

.toolbar-wrapper {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.table-wrapper {
  margin-bottom: 20px;
}

.pager-wrapper {
  display: flex;
  justify-content: flex-end;
}
</style>

.input-with-select .el-input-group__prepend { background-color: var(--el-fill-color-blank); }
